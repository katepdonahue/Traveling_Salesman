
<%= render 'map' %>
<button class="ajax">Get Best Route</button>

<script type="text/javascript">

  $(window).load(function() {
    
    function doEverything(callback) {

      
      // this builds the hash from the data from controller
      function buildData() {
        <% @data.each do |route_id, route_hash| %>
          var routeId = <%= route_id %>;
          data[routeId] = new Object();
          <% route_hash.each do |sub_route_id, address_arr| %>
            var subRouteId = <%= sub_route_id %>;
            var subRouteHash = new Object();
            subRouteHash["origin"] = "<%= address_arr.first %>";
            subRouteHash["destination"] = "<%= address_arr.last %>";
            // subRouteHash["departureTime"] = 1391530628316;
            subRouteHash["travelMode"] = google.maps.TravelMode.DRIVING;

            data[routeId][subRouteId] = subRouteHash;

          <% end %>
        <% end %>
      }
      // builds cache which gets filled with the google responses
      function buildCache() {
        var globalResponse = null;
        jQuery.each(data, function(routeId, routeHash) {
          cache[routeId] = new Object();
          jQuery.each(routeHash, function(subRouteId, subRouteHash) {
            directionsService.route(subRouteHash, function(response, status) {
              if (status == google.maps.DirectionsStatus.OK) {
                globalResponse = response;
                cache[routeId][subRouteId] = globalResponse;
              }
            });
          });
        });
      }
      
      // this sets each subroute hash to have a value of the "raw duration"
      function getAjaxHash() {
        var tripId = <%=@trip.id%>;
        var ajaxHash = new Object();
        ajaxHash[tripId] = new Object(); 
        jQuery.each(cache, function(routeId, routeHash) {
          ajaxHash[tripId][routeId] = new Object();
          jQuery.each(routeHash, function(subRouteId, subRouteHash) {
            ajaxHash[tripId][routeId][subRouteId] = cache[routeId][subRouteId]["routes"][0]["legs"][0]["duration"]["text"];
          });
        });
        return ajaxHash;
      }

      // initialize variables
      var data = new Object;        // <-- used in showRoutes
      var cache = new Object;       // <-- used in showRoutes
      var bestRouteId;              // <-- set in showRoutes
      var directionsDisplay = [];   // <-- filled in showRoutes
      var i = 0;                    // <-- incremented in showRoutes

      // get data and cache
      buildData();       
      buildCache();
      
      // calls showRoutes passing in the stuff it needs
      callback(getAjaxHash);
    }


    function showRoutes(myFunction) {
      
      // gives ajax hash to server, server finds best route and passes back route id
      $.post("/trips/ajax",
        myFunction(), // <-- this is what we pass to server
        function(response, status){
          console.log("in post, response = " + response + "status = " + status);
          bestRouteId = response["id"];
          // iterate through subroutes in best route adding them to the map
          $.each(cache[bestRouteId], function(subRouteId, googleResponse){ 
            console.log("getting ready to add sub routes to map");
            directionsDisplay[i] = new google.maps.DirectionsRenderer();
            directionsDisplay[i].setMap(map);
            directionsDisplay[i].setDirections(googleResponse);  
            i++;
          });
        }
      );

    }

    setTimeout(function() {
      doEverything(showRoutes);
      }, 2000);

  });
</script>



