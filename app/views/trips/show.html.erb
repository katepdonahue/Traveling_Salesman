
<%= render 'map' %>
<button class="ajax">Get Best Route</button>

<script type="text/javascript">

  var cache = new Object();
  var globalResponse = null;

  function buildHash(callback) {
    var data = new Object();
    <% @data.each do |route_id, route_hash| %>
      var routeId = <%= route_id %>;
      data[routeId] = new Object();
      <% route_hash.each do |sub_route_id, address_arr| %>
        var subRouteId = <%= sub_route_id %>;
        var subRouteHash = new Object();
        subRouteHash["origin"] = "<%= address_arr.first %>";
        subRouteHash["destination"] = "<%= address_arr.last %>";
        // subRouteHash["departureTime"] = 1391530628316;
        subRouteHash["travelMode"] = google.maps.TravelMode.DRIVING;

        data[routeId][subRouteId] = subRouteHash;

      <% end %>
    <% end %>

    jQuery.each(data, function(routeId, routeHash) {
      cache[routeId] = new Object();
      jQuery.each(routeHash, function(subRouteId, subRouteHash) {
        directionsService.route(subRouteHash, function(response, status) {
          if (status == google.maps.DirectionsStatus.OK) {
            globalResponse = response;
            cache[routeId][subRouteId] = globalResponse;
          }
        });
      });
    });
    callback(cache);
  }

  function getResponse(hash) {
    jQuery.each(hash, function(key, val) {
      jQuery.each(val, function(subrk, subrv) {
        directionsDisplay.setDirections(subrv);
      });
    });
  }

  buildHash(getResponse);
</script>
<script type="text/javascript">
  var tripId = <%=@trip.id%>;
  function getAjaxHash() {
    var ajaxHash = new Object();
    ajaxHash[tripId] = new Object(); 
    jQuery.each(cache, function(routeId, routeHash) {
      ajaxHash[tripId][routeId] = new Object();
      jQuery.each(routeHash, function(subRouteId, subRouteHash) {
        ajaxHash[tripId][routeId][subRouteId] = cache[routeId][subRouteId]["routes"][0]["legs"][0]["duration"]["text"];
      });
    });
    return ajaxHash;
  }
  var routeId;
  $(".ajax").on("click", function(){
    $.post("/trips/ajax",
      getAjaxHash(),
      function(response, status){
        debugger;
        bestRouteId = response["id"];
      }
    );
    $.each(cache, function(routeId, subRoutesHash){
      
    });
  });
</script>



